local TAU = math.pi * 2

local state = {
    t = 0,
    cpu = 0,
    ram = 0,
    gpu = 0,
    netIn = 0,
    netOut = 0,
    diskRead = 0,
    diskWrite = 0,
    diskSys = 0,
    diskData = 0,
    ping = 0,
    commit = 0,
    warn = 0,
    hCPU = 0,
    hRAM = 0,
    hDISK = 0,
    hNET = 0,
    hGPU = 0,
    hTHERM = 0,
    hPROC = 0
}

local last = {}
local m = {}
local dt = 0.025
local netMax = 12288
local warnCPU = 85
local warnGPU = 85
local warnRAM = 90
local shimmerPalette = { "6,224,255", "30,244,166", "255,168,58" }

local function num(v, d)
    local n = tonumber(v)
    if n == nil then
        return d
    end
    return n
end

local function clamp(v, a, b)
    if v < a then
        return a
    end
    if v > b then
        return b
    end
    return v
end

local function lerp(a, b, t)
    return a + ((b - a) * t)
end

local function response(speed)
    return clamp(speed * dt, 0.02, 0.35)
end

local function wave(x)
    return (math.sin(x) * 0.5) + 0.5
end

local function setvar(name, value, fmt)
    local s
    if type(value) == "number" then
        if fmt then
            s = string.format(fmt, value)
        else
            s = string.format("%.3f", value)
        end
    else
        s = tostring(value)
    end

    if last[name] ~= s then
        SKIN:Bang("!SetVariable", name, s)
        last[name] = s
    end
end

local function getm(name, default)
    local measure = m[name]
    if not measure then
        return default
    end

    local v = measure:GetValue()
    if v == nil then
        return default
    end

    return v
end

function Initialize()
    m = {
        cpu = SKIN:GetMeasure("MeasureCPU"),
        ram = SKIN:GetMeasure("MeasureRAM"),
        gpu = SKIN:GetMeasure("MeasureGPU"),
        netInKB = SKIN:GetMeasure("MeasureNetInKB"),
        netOutKB = SKIN:GetMeasure("MeasureNetOutKB"),
        diskRead = SKIN:GetMeasure("MeasureDiskReadMB"),
        diskWrite = SKIN:GetMeasure("MeasureDiskWriteMB"),
        diskSys = SKIN:GetMeasure("MeasureDiskSysUsed"),
        diskData = SKIN:GetMeasure("MeasureDiskDataUsed"),
        ping = SKIN:GetMeasure("MeasurePing"),
        commit = SKIN:GetMeasure("MeasureCommitPct")
    }

    dt = clamp(num(SKIN:GetVariable("UpdateMs", "25"), 25) / 1000, 0.01, 0.20)
    netMax = math.max(num(SKIN:GetVariable("NetMaxKB", "12288"), 12288), 1)
    warnCPU = num(SKIN:GetVariable("CPUWarn", "85"), 85)
    warnGPU = num(SKIN:GetVariable("GPUWarn", "85"), 85)
    warnRAM = num(SKIN:GetVariable("RAMWarn", "90"), 90)

    shimmerPalette[1] = SKIN:GetVariable("Cyan", "6,224,255")
    shimmerPalette[2] = SKIN:GetVariable("Green", "30,244,166")
    shimmerPalette[3] = SKIN:GetVariable("Orange", "255,168,58")

    state.t = 0
end

local function updateHover(key)
    local target = num(SKIN:GetVariable("Hover" .. key .. "_Target", "0"), 0)
    local id = "h" .. key
    state[id] = lerp(state[id], target, response(6.4))
    setvar("Hover" .. key, state[id], "%.3f")
end

function Update()
    state.t = state.t + dt

    local cpuRaw = getm("cpu", state.cpu)
    local ramRaw = getm("ram", state.ram)
    local gpuRaw = getm("gpu", state.gpu)
    local netInRaw = getm("netInKB", state.netIn)
    local netOutRaw = getm("netOutKB", state.netOut)
    local diskReadRaw = getm("diskRead", state.diskRead)
    local diskWriteRaw = getm("diskWrite", state.diskWrite)
    local diskSysRaw = getm("diskSys", state.diskSys)
    local diskDataRaw = getm("diskData", state.diskData)
    local pingRaw = getm("ping", state.ping)
    local commitRaw = getm("commit", state.commit)

    state.cpu = lerp(state.cpu, cpuRaw, response(7.2))
    state.ram = lerp(state.ram, ramRaw, response(4.8))
    state.gpu = lerp(state.gpu, gpuRaw, response(4.0))
    state.netIn = lerp(state.netIn, netInRaw, response(8.8))
    state.netOut = lerp(state.netOut, netOutRaw, response(8.8))
    state.diskRead = lerp(state.diskRead, diskReadRaw, response(7.2))
    state.diskWrite = lerp(state.diskWrite, diskWriteRaw, response(7.2))
    state.diskSys = lerp(state.diskSys, diskSysRaw, response(3.2))
    state.diskData = lerp(state.diskData, diskDataRaw, response(3.2))
    state.ping = lerp(state.ping, pingRaw, response(5.6))
    state.commit = lerp(state.commit, commitRaw, response(4.0))

    updateHover("CPU")
    updateHover("RAM")
    updateHover("DISK")
    updateHover("NET")
    updateHover("GPU")
    updateHover("THERM")
    updateHover("PROC")

    local warnTarget = 0
    if state.cpu > warnCPU or state.ram > warnRAM or state.gpu > warnGPU then
        warnTarget = 1
    end
    state.warn = lerp(state.warn, warnTarget, response(4.0))

    local ringA = (state.t * 0.84) % TAU
    local ringB = (state.t * 0.44) % TAU
    local scanT = (state.t * 0.048) % 1
    local shimmerT1 = (state.t * 0.31) % 1
    local shimmerT2 = ((state.t * 0.27) + 0.33) % 1
    local shimmerT3 = ((state.t * 0.25) + 0.66) % 1
    local cornerA = math.floor(26 + (wave(state.t * 1.7) * 136))

    local jitterX = clamp(math.floor((math.sin(state.t * 13.2) + math.sin(state.t * 7.8)) * 0.75), -1, 1)
    local jitterY = clamp(math.floor((math.cos(state.t * 11.6) + math.sin(state.t * 5.2)) * 0.70), -1, 1)

    local tracerT = (state.t * 0.10) % 1
    local safeNetMax = math.max(netMax, 1)
    local netMix = clamp((state.netIn + state.netOut) / (safeNetMax * 1.35), 0, 1)
    local tracerYN = clamp(0.86 - (netMix * 0.68) + (math.sin(state.t * 4.6) * 0.03), 0.08, 0.92)

    local noiseX = math.floor((wave(state.t * 2.9) * 12) - 6)
    local noiseY = math.floor((wave((state.t * 2.3) + 0.8) * 10) - 5)
    local parallaxX = math.sin(state.t * 0.42) * 4.5
    local parallaxY = math.cos(state.t * 0.37) * 3.6

    local shimmerIdx = (math.floor(state.t * 0.7) % 3) + 1
    local shimmerIdx2 = ((shimmerIdx + 1) % 3) + 1
    local shimmerIdx3 = ((shimmerIdx + 2) % 3) + 1
    local shimmerA = math.floor(18 + (wave(state.t * 6.2) * 22))

    local blip1x = (state.t * 0.19) % 1
    local blip2x = ((state.t * 0.16) + 0.24) % 1
    local blip3x = ((state.t * 0.21) + 0.53) % 1
    local blip4x = ((state.t * 0.14) + 0.77) % 1

    local blip1y = ((state.t * 0.24) + 0.08) % 1
    local blip2y = ((state.t * 0.21) + 0.31) % 1
    local blip3y = ((state.t * 0.18) + 0.57) % 1
    local blip4y = ((state.t * 0.27) + 0.81) % 1

    local warnFlash = math.floor(state.warn * (12 + (wave(state.t * 12.5) * 34)))

    setvar("CPU_S", clamp(state.cpu, 0, 100), "%.2f")
    setvar("RAM_S", clamp(state.ram, 0, 100), "%.2f")
    setvar("GPU_S", clamp(state.gpu, 0, 100), "%.2f")
    local netInPct = clamp((state.netIn / safeNetMax) * 100, 0, 100)
    local netOutPct = clamp((state.netOut / safeNetMax) * 100, 0, 100)

    setvar("NetInKB_S", math.max(state.netIn, 0), "%.2f")
    setvar("NetOutKB_S", math.max(state.netOut, 0), "%.2f")
    setvar("NetInPct_S", netInPct, "%.2f")
    setvar("NetOutPct_S", netOutPct, "%.2f")
    setvar("DiskReadMB_S", math.max(state.diskRead, 0), "%.2f")
    setvar("DiskWriteMB_S", math.max(state.diskWrite, 0), "%.2f")
    setvar("DiskSysUsed_S", clamp(state.diskSys, 0, 100), "%.2f")
    setvar("DiskDataUsed_S", clamp(state.diskData, 0, 100), "%.2f")
    setvar("Ping_S", math.max(state.ping, 0), "%.2f")
    setvar("Commit_S", clamp(state.commit, 0, 100), "%.2f")

    setvar("RingAngle", ringA, "%.3f")
    setvar("RingAngleSlow", ringB, "%.3f")
    setvar("ScanT", scanT, "%.3f")
    setvar("ShimmerT1", shimmerT1, "%.3f")
    setvar("ShimmerT2", shimmerT2, "%.3f")
    setvar("ShimmerT3", shimmerT3, "%.3f")
    setvar("CornerPulse", cornerA, "%d")
    setvar("JitterX", jitterX, "%d")
    setvar("JitterY", jitterY, "%d")
    setvar("TracerT", tracerT, "%.3f")
    setvar("TracerYN", tracerYN, "%.3f")
    setvar("NoiseShiftX", noiseX, "%d")
    setvar("NoiseShiftY", noiseY, "%d")
    setvar("ParallaxX", parallaxX, "%.2f")
    setvar("ParallaxY", parallaxY, "%.2f")
    setvar("WarnFlashA", warnFlash, "%d")
    setvar("WarnBlend", state.warn, "%.2f")

    setvar("ShimmerRGB1", shimmerPalette[shimmerIdx])
    setvar("ShimmerRGB2", shimmerPalette[shimmerIdx2])
    setvar("ShimmerRGB3", shimmerPalette[shimmerIdx3])
    setvar("ShimmerA", shimmerA, "%d")

    setvar("Blip1X", blip1x, "%.3f")
    setvar("Blip1Y", blip1y, "%.3f")
    setvar("Blip2X", blip2x, "%.3f")
    setvar("Blip2Y", blip2y, "%.3f")
    setvar("Blip3X", blip3x, "%.3f")
    setvar("Blip3Y", blip3y, "%.3f")
    setvar("Blip4X", blip4x, "%.3f")
    setvar("Blip4Y", blip4y, "%.3f")

    return 0
end
